{"cells":[{"cell_type":"code","execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":27041,"status":"ok","timestamp":1614488923088,"user":{"displayName":"Guys Users","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GjPDLTE2xq9CHYxzYfOVoXbFT7HwhIJa5bkbk16=s64","userId":"03786715776420508747"},"user_tz":-420},"id":"VJBip-Gt4gKQ","outputId":"4ce4e719-c54e-4ce1-857b-b7cfa8b4d877"},"outputs":[{"name":"stdout","output_type":"stream","text":["\u001b[K     |████████████████████████████████| 3.4MB 4.9MB/s \n","\u001b[K     |████████████████████████████████| 1.1MB 6.5MB/s \n","\u001b[K     |████████████████████████████████| 51kB 5.0MB/s \n","\u001b[K     |████████████████████████████████| 102kB 7.0MB/s \n","\u001b[K     |████████████████████████████████| 1.2MB 15.8MB/s \n","\u001b[K     |████████████████████████████████| 358kB 27.9MB/s \n","\u001b[K     |████████████████████████████████| 174kB 30.9MB/s \n","\u001b[K     |████████████████████████████████| 706kB 26.1MB/s \n","\u001b[K     |████████████████████████████████| 645kB 22.4MB/s \n","\u001b[K     |████████████████████████████████| 37.6MB 95kB/s \n","\u001b[?25h  Building wheel for seqeval (setup.py) ... \u001b[?25l\u001b[?25hdone\n","  Building wheel for py-cpuinfo (setup.py) ... \u001b[?25l\u001b[?25hdone\n","Collecting tfds-nightly\n","\u001b[?25l  Downloading https://files.pythonhosted.org/packages/cf/43/83a554ba7679b00faf283204e5fb603eb378e098c64008bafe7e73f3371a/tfds_nightly-4.2.0.dev202102270106-py3-none-any.whl (3.8MB)\n","\u001b[K     |████████████████████████████████| 3.8MB 6.6MB/s \n","\u001b[?25hRequirement already satisfied, skipping upgrade: six in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (1.15.0)\n","Requirement already satisfied, skipping upgrade: importlib-resources; python_version \u003c \"3.9\" in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (5.1.0)\n","Requirement already satisfied, skipping upgrade: termcolor in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (1.1.0)\n","Requirement already satisfied, skipping upgrade: numpy in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (1.19.5)\n","Requirement already satisfied, skipping upgrade: promise in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (2.3)\n","Requirement already satisfied, skipping upgrade: absl-py in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (0.10.0)\n","Requirement already satisfied, skipping upgrade: typing-extensions; python_version \u003c \"3.8\" in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (3.7.4.3)\n","Requirement already satisfied, skipping upgrade: attrs\u003e=18.1.0 in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (20.3.0)\n","Requirement already satisfied, skipping upgrade: protobuf\u003e=3.12.2 in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (3.12.4)\n","Requirement already satisfied, skipping upgrade: tensorflow-metadata in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (0.28.0)\n","Requirement already satisfied, skipping upgrade: future in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (0.16.0)\n","Requirement already satisfied, skipping upgrade: tqdm in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (4.41.1)\n","Requirement already satisfied, skipping upgrade: requests\u003e=2.19.0 in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (2.23.0)\n","Requirement already satisfied, skipping upgrade: dill in /usr/local/lib/python3.7/dist-packages (from tfds-nightly) (0.3.3)\n","Requirement already satisfied, skipping upgrade: zipp\u003e=0.4; python_version \u003c \"3.8\" in /usr/local/lib/python3.7/dist-packages (from importlib-resources; python_version \u003c \"3.9\"-\u003etfds-nightly) (3.4.0)\n","Requirement already satisfied, skipping upgrade: setuptools in /usr/local/lib/python3.7/dist-packages (from protobuf\u003e=3.12.2-\u003etfds-nightly) (53.0.0)\n","Requirement already satisfied, skipping upgrade: googleapis-common-protos\u003c2,\u003e=1.52.0 in /usr/local/lib/python3.7/dist-packages (from tensorflow-metadata-\u003etfds-nightly) (1.52.0)\n","Requirement already satisfied, skipping upgrade: certifi\u003e=2017.4.17 in /usr/local/lib/python3.7/dist-packages (from requests\u003e=2.19.0-\u003etfds-nightly) (2020.12.5)\n","Requirement already satisfied, skipping upgrade: idna\u003c3,\u003e=2.5 in /usr/local/lib/python3.7/dist-packages (from requests\u003e=2.19.0-\u003etfds-nightly) (2.10)\n","Requirement already satisfied, skipping upgrade: chardet\u003c4,\u003e=3.0.2 in /usr/local/lib/python3.7/dist-packages (from requests\u003e=2.19.0-\u003etfds-nightly) (3.0.4)\n","Requirement already satisfied, skipping upgrade: urllib3!=1.25.0,!=1.25.1,\u003c1.26,\u003e=1.21.1 in /usr/local/lib/python3.7/dist-packages (from requests\u003e=2.19.0-\u003etfds-nightly) (1.24.3)\n","Installing collected packages: tfds-nightly\n","Successfully installed tfds-nightly-4.2.0.dev202102270106\n"]}],"source":["!pip install -q -U tensorflow-text\r\n","!pip install -q -U tf-models-official\r\n","!pip install -U tfds-nightly"]},{"cell_type":"code","execution_count":2,"metadata":{"executionInfo":{"elapsed":29430,"status":"ok","timestamp":1614488925487,"user":{"displayName":"Guys Users","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GjPDLTE2xq9CHYxzYfOVoXbFT7HwhIJa5bkbk16=s64","userId":"03786715776420508747"},"user_tz":-420},"id":"_Gjdotxj4wPX"},"outputs":[],"source":["import os\r\n","import tensorflow as tf\r\n","import tensorflow_hub as hub\r\n","import tensorflow_datasets as tfds\r\n","import tensorflow_text as text  # A dependency of the preprocessing model\r\n","import tensorflow_addons as tfa\r\n","from official.nlp import optimization\r\n","import numpy as np"]},{"cell_type":"code","execution_count":3,"metadata":{"executionInfo":{"elapsed":29425,"status":"ok","timestamp":1614488925494,"user":{"displayName":"Guys Users","photoUrl":"https://lh3.googleusercontent.com/a-/AOh14GjPDLTE2xq9CHYxzYfOVoXbFT7HwhIJa5bkbk16=s64","userId":"03786715776420508747"},"user_tz":-420},"id":"j4Vaq2RY4-L7"},"outputs":[],"source":["# Read checkpoint direct from cloud\r\n","os.environ[\"TFHUB_MODEL_LOAD_FORMAT\"] = \"UNCOMPRESSED\""]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"XMi_xkXV5KTt","outputId":"0b7ab572-9611-48d3-edc1-2681ae626ffe"},"outputs":[{"name":"stdout","output_type":"stream","text":["INFO:tensorflow:Initializing the TPU system: grpc://10.96.68.194:8470\n"]},{"name":"stderr","output_type":"stream","text":["INFO:tensorflow:Initializing the TPU system: grpc://10.96.68.194:8470\n"]}],"source":["if os.environ['COLAB_TPU_ADDR']:\r\n","    cluster_resolver = tf.distribute.cluster_resolver.TPUClusterResolver(tpu='grpc://' + os.environ['COLAB_TPU_ADDR'])\r\n","    tf.config.experimental_connect_to_cluster(cluster_resolver)\r\n","    tf.tpu.experimental.initialize_tpu_system(cluster_resolver)\r\n","    strategy = tf.distribute.TPUStrategy(cluster_resolver)\r\n","    print(\"USING TPU\")\r\n","elif tf.test.is_gpu_available():\r\n","    strategy = tf.distribute.MirroredStrategy()\r\n","    print(\"USING GPU\")\r\n","else:\r\n","    raise ValueError(\"Can not run on CPU\")\r\n","\r\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"68p1m5X167V1"},"outputs":[],"source":["bert_model_name = 'bert_en_uncased_L-12_H-768_A-12' \r\n","\r\n","map_name_to_handle = {\r\n","    'bert_en_uncased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_L-12_H-768_A-12/3',\r\n","    'bert_en_uncased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_L-24_H-1024_A-16/3',\r\n","    'bert_en_wwm_uncased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_wwm_uncased_L-24_H-1024_A-16/3',\r\n","    'bert_en_cased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_cased_L-12_H-768_A-12/3',\r\n","    'bert_en_cased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_cased_L-24_H-1024_A-16/3',\r\n","    'bert_en_wwm_cased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_wwm_cased_L-24_H-1024_A-16/3',\r\n","    'bert_multi_cased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_multi_cased_L-12_H-768_A-12/3',\r\n","    'small_bert/bert_en_uncased_L-2_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-2_H-128_A-2/1',\r\n","    'small_bert/bert_en_uncased_L-2_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-2_H-256_A-4/1',\r\n","    'small_bert/bert_en_uncased_L-2_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-2_H-512_A-8/1',\r\n","    'small_bert/bert_en_uncased_L-2_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-2_H-768_A-12/1',\r\n","    'small_bert/bert_en_uncased_L-4_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-4_H-128_A-2/1',\r\n","    'small_bert/bert_en_uncased_L-4_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-4_H-256_A-4/1',\r\n","    'small_bert/bert_en_uncased_L-4_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-4_H-512_A-8/1',\r\n","    'small_bert/bert_en_uncased_L-4_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-4_H-768_A-12/1',\r\n","    'small_bert/bert_en_uncased_L-6_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-6_H-128_A-2/1',\r\n","    'small_bert/bert_en_uncased_L-6_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-6_H-256_A-4/1',\r\n","    'small_bert/bert_en_uncased_L-6_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-6_H-512_A-8/1',\r\n","    'small_bert/bert_en_uncased_L-6_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-6_H-768_A-12/1',\r\n","    'small_bert/bert_en_uncased_L-8_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-8_H-128_A-2/1',\r\n","    'small_bert/bert_en_uncased_L-8_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-8_H-256_A-4/1',\r\n","    'small_bert/bert_en_uncased_L-8_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-8_H-512_A-8/1',\r\n","    'small_bert/bert_en_uncased_L-8_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-8_H-768_A-12/1',\r\n","    'small_bert/bert_en_uncased_L-10_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-10_H-128_A-2/1',\r\n","    'small_bert/bert_en_uncased_L-10_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-10_H-256_A-4/1',\r\n","    'small_bert/bert_en_uncased_L-10_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-10_H-512_A-8/1',\r\n","    'small_bert/bert_en_uncased_L-10_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-10_H-768_A-12/1',\r\n","    'small_bert/bert_en_uncased_L-12_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-12_H-128_A-2/1',\r\n","    'small_bert/bert_en_uncased_L-12_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-12_H-256_A-4/1',\r\n","    'small_bert/bert_en_uncased_L-12_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-12_H-512_A-8/1',\r\n","    'small_bert/bert_en_uncased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/small_bert/bert_en_uncased_L-12_H-768_A-12/1',\r\n","    'albert_en_base':\r\n","        'https://tfhub.dev/tensorflow/albert_en_base/2',\r\n","    'albert_en_large':\r\n","        'https://tfhub.dev/tensorflow/albert_en_large/2',\r\n","    'albert_en_xlarge':\r\n","        'https://tfhub.dev/tensorflow/albert_en_xlarge/2',\r\n","    'albert_en_xxlarge':\r\n","        'https://tfhub.dev/tensorflow/albert_en_xxlarge/2',\r\n","    'electra_small':\r\n","        'https://tfhub.dev/google/electra_small/2',\r\n","    'electra_base':\r\n","        'https://tfhub.dev/google/electra_base/2',\r\n","    'experts_pubmed':\r\n","        'https://tfhub.dev/google/experts/bert/pubmed/2',\r\n","    'experts_wiki_books':\r\n","        'https://tfhub.dev/google/experts/bert/wiki_books/2',\r\n","    'talking-heads_base':\r\n","        'https://tfhub.dev/tensorflow/talkheads_ggelu_bert_en_base/1',\r\n","    'talking-heads_large':\r\n","        'https://tfhub.dev/tensorflow/talkheads_ggelu_bert_en_large/1',\r\n","}\r\n","\r\n","map_model_to_preprocess = {\r\n","    'bert_en_uncased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'bert_en_uncased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'bert_en_wwm_cased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_cased_preprocess/3',\r\n","    'bert_en_cased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_cased_preprocess/3',\r\n","    'bert_en_cased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_cased_preprocess/3',\r\n","    'bert_en_wwm_uncased_L-24_H-1024_A-16':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-2_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-2_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-2_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-2_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-4_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-4_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-4_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-4_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-6_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-6_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-6_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-6_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-8_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-8_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-8_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-8_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-10_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-10_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-10_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-10_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-12_H-128_A-2':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-12_H-256_A-4':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-12_H-512_A-8':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'small_bert/bert_en_uncased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'bert_multi_cased_L-12_H-768_A-12':\r\n","        'https://tfhub.dev/tensorflow/bert_multi_cased_preprocess/3',\r\n","    'albert_en_base':\r\n","        'https://tfhub.dev/tensorflow/albert_en_preprocess/2',\r\n","    'albert_en_large':\r\n","        'https://tfhub.dev/tensorflow/albert_en_preprocess/2',\r\n","    'albert_en_xlarge':\r\n","        'https://tfhub.dev/tensorflow/albert_en_preprocess/2',\r\n","    'albert_en_xxlarge':\r\n","        'https://tfhub.dev/tensorflow/albert_en_preprocess/2',\r\n","    'electra_small':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'electra_base':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'experts_pubmed':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'experts_wiki_books':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'talking-heads_base':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","    'talking-heads_large':\r\n","        'https://tfhub.dev/tensorflow/bert_en_uncased_preprocess/3',\r\n","}\r\n","\r\n","tfhub_handle_encoder = map_name_to_handle[bert_model_name]\r\n","tfhub_handle_preprocess = map_model_to_preprocess[bert_model_name]\r\n","\r\n","print(f'BERT model selected           : {tfhub_handle_encoder}')\r\n","print(f'Preprocessing model auto-selected: {tfhub_handle_preprocess}')"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"uLdCp-DF8vHM"},"outputs":[],"source":["# Preprocess data\r\n","bert_preprocess = hub.load(tfhub_handle_preprocess)\r\n","token = bert_preprocess.tokenize(tf.constant(['Hello World!']))\r\n","token"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"e8Dg50JQ-N2B"},"outputs":[],"source":["# Take a list of token to create input required by BERT\r\n","text_preprocessed = bert_preprocess.bert_pack_inputs([token, token], tf.constant(20))\r\n","print('Shape Word Ids : ', text_preprocessed['input_word_ids'].shape)\r\n","print('Word Ids       : ', text_preprocessed['input_word_ids'][0, :16])\r\n","print('Shape Mask     : ', text_preprocessed['input_mask'].shape)\r\n","print('Input Mask     : ', text_preprocessed['input_mask'][0, :16])\r\n","print('Shape Type Ids : ', text_preprocessed['input_type_ids'].shape)\r\n","print('Type Ids       : ', text_preprocessed['input_type_ids'][0, :16])"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"2CLafbIa_nMb"},"outputs":[],"source":["def build_bert_preprocess_model(sentence_features, seq_len=256):\r\n","    \"\"\"Returns Model mapping string features to BERT inputs.\r\n","\r\n","    Args:\r\n","      sentence_features: a list with the names of string-valued features.\r\n","      seq_length: an integer that defines the sequence length of BERT inputs.\r\n","\r\n","    Returns:\r\n","      A Keras Model that can be called on a list or dict of string Tensors\r\n","      (with the order or names, resp., given by sentence_features) and\r\n","      returns a dict of tensors for input to BERT.\r\n","    \"\"\"\r\n","    input_segments = [tf.keras.layers.Input(shape=(), dtype=tf.string, name=feature) for feature in sentence_features]\r\n","\r\n","    # Tokenize text to word\r\n","    bert_preprocess = hub.load(tfhub_handle_preprocess)\r\n","    tokenizer = hub.KerasLayer(bert_preprocess.tokenize, name=\"tokenizer\")\r\n","    segments = [tokenizer(s) for s in input_segments]\r\n","\r\n","    # Optional: Trim segments in a smart way to fit seq_length.\r\n","    # Simple cases (like this example) can skip this step and let\r\n","    # the next step apply a default truncation to approximately equal lengths.\r\n","\r\n","    truncated_segments = segments\r\n","\r\n","    # Pack inputs. The details (start/end token ids, dict of output tensors)\r\n","    # are model-dependent, so this gets loaded from the SavedModel.\r\n","    packer = hub.KerasLayer(bert_preprocess.bert_pack_inputs, arguments=dict(seq_length=seq_len), name=\"packer\")\r\n","    model_inputs = packer(truncated_segments)\r\n","\r\n","    # Input bert expected (input_word_id, input_masks, input_type_ids)\r\n","    return tf.keras.Model(input_segments, model_inputs)\r\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"R31yzZbRZG82"},"outputs":[],"source":["test_preprocess_model = build_bert_preprocess_model(['my_input1', 'my_input2'])\r\n","test_text = [np.array(['some random test sentence']),\r\n","             np.array(['another sentence'])]\r\n","text_preprocessed = test_preprocess_model(test_text)\r\n","\r\n","print('Keys           : ', list(text_preprocessed.keys()))\r\n","print('Shape Word Ids : ', text_preprocessed['input_word_ids'].shape)\r\n","print('Word Ids       : ', text_preprocessed['input_word_ids'][0, :16])\r\n","print('Shape Mask     : ', text_preprocessed['input_mask'].shape)\r\n","print('Input Mask     : ', text_preprocessed['input_mask'][0, :16])\r\n","print('Shape Type Ids : ', text_preprocessed['input_type_ids'].shape)\r\n","print('Type Ids       : ', text_preprocessed['input_type_ids'][0, :16])"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"2QOHjBofatrO"},"outputs":[],"source":["tf.keras.utils.plot_model(test_preprocess_model)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"AGIZ-_SQbDMQ"},"outputs":[],"source":["AUTOTUNE = tf.data.AUTOTUNE\r\n","\r\n","def load_datasets_from_tf_datasets(in_memory_dataset, info, split, batch_size, \r\n","                                   bert_preprocess_model):\r\n","    is_training = split.startswith(\"train\")\r\n","    dataset = tf.data.Dataset.from_tensor_slices(in_memory_dataset[split])\r\n","    num_examples = info.splits[split].num_examples\r\n","\r\n","    if is_training:\r\n","        daataset = dataset.shuffle(num_examples)\r\n","        dataset = dataset.repeat()\r\n","\r\n","    dataset = dataset.batch(batch_size)\r\n","    dataset = dataset.map(lambda d: (bert_preprocess_model(d), d['label']))\r\n","    dataset = dataset.cache().prefetch(buffer_size=AUTOTUNE)\r\n","    return dataset, num_examples\r\n","\r\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"nWu9BaYycVWe"},"outputs":[],"source":["def build_classifier_model(num_classes):\r\n","    inputs = dict(\r\n","        input_word_ids=tf.keras.layers.Input(shape=(None, ), dtype=tf.int32),\r\n","        input_mask=tf.keras.layers.Input(shape=(None, ), dtype=tf.int32),\r\n","        input_type_ids=tf.keras.layers.Input(shape=(None, ), dtype=tf.int32),\r\n","    )\r\n","\r\n","    encoder = hub.KerasLayer(tfhub_handle_encoder, trainable=True, name='encoder')\r\n","    net = encoder(inputs)['pooled_output']\r\n","    net = tf.keras.layers.Dropout(rate=.1)(net)\r\n","    net = tf.keras.layers.Dense(num_classes, activation=None, name=\"classifier\")(net)\r\n","    return tf.keras.Model(inputs, net, name='prediction')\r\n","    "]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"G-4Zj0_3ju-4"},"outputs":[{"name":"stdout","output_type":"stream","text":["WARNING:tensorflow:9 out of the last 10 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f430ce9b200\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stderr","output_type":"stream","text":["WARNING:tensorflow:9 out of the last 10 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f430ce9b200\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stdout","output_type":"stream","text":["tf.Tensor([[0.6147511 0.8184364]], shape=(1, 2), dtype=float32)\n"]}],"source":["test_classifier_model = build_classifier_model(2)\r\n","bert_raw_result = test_classifier_model(text_preprocessed)\r\n","print(tf.sigmoid(bert_raw_result))"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"ZvUOjMKGkKWA"},"outputs":[{"data":{"image/png":"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LE9ERERECrA8ERERESnA8kRERESkAMsTERERkQIsT0REREQKsDwRERERKcDyRERERKQAyxMRERGRAjZqByCyRLm5uUhOTlY7BhERqYDliagJDh06hMjISLVjEBGRCjQiImqHICL6reTkZERGRoJ/PRGRGUrhNU9ERERECrA8ERERESnA8kRERESkAMsTERERkQIsT0REREQKsDwRERERKcDyRERERKQAyxMRERGRAixPRERERAqwPBEREREpwPJEREREpADLExEREZECLE9ERERECrA8ERERESnA8kRERESkAMsTERERkQIsT0REREQKsDwRERERKcDyRERERKQAyxMRERGRAixPRERERAqwPBEREREpwPJEREREpADLExEREZECLE9ERERECrA8ERERESnA8kRERESkAMsTERERkQIsT0REREQKsDwRERERKcDyRERERKQAyxMRERGRAixPRERERArYqB2AiB5s169fxz/+8Q+jZcePHwcAxMfHGy13c3PDiy++aKpoRER10oiIqB2CiB5cVVVV6NixI4qKimBj83//Pyci0Gg0hj+Xl5dj+vTpWLdunRoxiYjuSeFpOyJSlY2NDaKiomBlZYXy8nLDo6KiwujPADBx4kSV0xIR8ZonIjIDEyZMQGVlZYPbuLu7Y/jw4SZKRERUP5YnIlLdY489hs6dO9e73s7ODtHR0bC2tjZhKiKiurE8EZHqNBoNJk+eDFtb2zrXV1RUYMKECSZORURUN5YnIjILDZ268/HxwSOPPGLiREREdWN5IiKz0L9/f3Tt2rXWcjs7O0yZMsX0gYiI6sHyRERmIzo6utapu4qKCkRGRqqUiIioNpYnIjIbEyZMQFVVleHPGo0Gffv2RY8ePVRMRURkjOWJiMxGQEAA+vfvDyurX/9qsrGxQXR0tMqpiIiMsTwRkVmJjo42lKeqqiqesiMis8PyRERmJTIyEjU1NQCAoUOHwtPTU+VERETGWJ6IyKx06tTJ8E3izz33nMppiIhq4w8DE7WS8PBwpKamqh2DHlBJSUmIiIhQOwZRW5Ric/9tiKipgoKC8PLLL6sdw+KUlJRg3bp1PHZNxOvEiFoXyxNRK/L09OT//TfRyJEjeb1TE7E8EbUuXvNERGaJxYmIzBXLExEREZECLE9ERERECrA8ERERESnA8kRERESkAMsTERERkQIs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qaFjZy6vnYiah+WJyALcu17G1dVV0fO++OILjBgxAu7u7tBqtXjttdcM6+zt7fHNN99g2LBhWLp0Kfz9/REVFYWysrIG1zVXSUkJAOCNN94w+h6mnJwclJaWNnv8xjp37hwAoHv37i2aq6FjZy6vnYiah+WJyAJ07twZAHDjxo1GP+fixYsYN24cPDw8cPjwYRQVFSE+Pt5om169eiEtLQ1XrlxBbGwskpKS8O677953XXO4u7sDAFauXAkRMXqkp6c3e/zG2r17NwBg1KhRLZ6rvmNnLq+diJqH5YnIAvj6+qJdu3b46quvGv2cEydOoLKyErNnz4a/vz90Oh00Go1h/ZUrV3D69GkAvxaHt99+GwMHDsTp06cbXNdcXl5e0Ol0+Pnnn5s9VlNdu3YNK1euhKenJ55//vkWzdXQsTOH105EzcfyRGQBtFotFixYgG+//RZz5szB5cuXUVNTg9u3b9dbaLy9vQEAe/bswd27d5GZmYnDhw8b1l+5cgUzZ87E2bNnUVFRgaNHjyInJwdBQUENrmsunU6HqVOnYvPmzVi7di2Ki4tRXV2N3NxcXL16tcHn7tq1S9FXFcj/3vVXU1MDEUF+fj6SkpLw2GOPwdraGtu2bTNc89ScXL/V0LFrqX0QkcpUuEqd6IHX1LulVq9eLX369BGdTic6nU4GDBgga9askffee086duwoAMTBwUHGjx8vIiKxsbHSrl07cXV1lfDwcFm9erUAkICAADlw4IAEBweLm5ubWFtbS+fOnWXhwoVSVVUl2dnZ9a5btWqVeHh4CADR6/UyZswYyc7OlgEDBggAsbGxkYEDB0pqamqd24qIlJeXS2xsrHh7e4uNjY24u7tLaGionDp1SuLj48Xe3l4AiJeXl2zatMnw+nfu3ClOTk6yZMmSeo/R9u3bpW/fvqLX68XOzk6srKwEgOHOuiFDhsjixYuloKCg1nMbyrVmzRrR6/UCQLp27SpZWVmybt06cXZ2FgDi4+Mj586da/DY3W8fjcW77YhUlawRMfEPTxERkpOTERkZafLffaO2ge8fIlWl8LQdERERkQIsT0REREQKsDwRERERKcDyRERERKQAyxMRERGRAixPRERERAqwPBEREREpwPJEREREpADLExEREZECLE9ERERECrA8ERERESnA8kRERESkAMsTERERkQIsT0REREQKsDwRERERKcDyRERERKQAyxMRERGRAjZqByB6kIWHh6sdgSxQbm6u2hGIHmj85IlIBV5eXggLC1M7BlkoT09Pvn+IVKQREVE7BBEREZGFSOEnT0REREQKsDwRERERKcDyRERERKQAyxMRERGRAv8f7Fqz6VjXo6gAAAAASUVORK5CYII=\n","text/plain":["\u003cIPython.core.display.Image object\u003e"]},"execution_count":null,"metadata":{},"output_type":"execute_result"}],"source":["tf.keras.utils.plot_model(test_classifier_model)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"eHhrqrV6kH3y"},"outputs":[{"name":"stdout","output_type":"stream","text":["Using glue/cola from TFDS\n","This dataset has 10657 examples\n","Number of classes: 2\n","Features ['sentence']\n","Splits ['test', 'train', 'validation']\n","\u001b[1mDownloading and preparing dataset 368.14 KiB (download: 368.14 KiB, generated: Unknown size, total: 368.14 KiB) to /root/tensorflow_datasets/glue/cola/1.0.0...\u001b[0m\n"]},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"008ef4679b8b44ac9ead55eac5a0004c","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=1.0, bar_style='info', description='Dl Completed...', max=1.0, style=Progre…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"f1f1ff032c134b338bdda797501dd5f4","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=1.0, bar_style='info', description='Dl Size...', max=1.0, style=ProgressSty…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"200477f1799845acbaa910c910084890","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=1.0, bar_style='info', description='Extraction completed...', max=1.0, styl…"]},"metadata":{},"output_type":"display_data"},{"name":"stdout","output_type":"stream","text":["\n","\n","\n","\n","\n","\n"]},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"51730fd73e7a46f8a211e69d60406b19","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=0.0, description='Generating splits...', max=3.0, style=ProgressStyle(descr…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"9ddb7c768a9d4f9591c1e1b9c779c7ed","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=0.0, description='Generating train examples...', max=8551.0, style=Progress…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"442a39a436364f11a22f75734b7df2af","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=0.0, description='Shuffling glue-train.tfrecord...', max=8551.0, style=Prog…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"9f09118a68814ca3b0453f4a746c459a","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=0.0, description='Generating validation examples...', max=1043.0, style=Pro…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"57ce588cc8ff434dbb922db1bc1a96a1","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=0.0, description='Shuffling glue-validation.tfrecord...', max=1043.0, style…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"94d791e3a0444a4482ae4228dcce9706","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=0.0, description='Generating test examples...', max=1063.0, style=ProgressS…"]},"metadata":{},"output_type":"display_data"},{"data":{"application/vnd.jupyter.widget-view+json":{"model_id":"5ec035a28285416c9042843e69b09b4d","version_major":2,"version_minor":0},"text/plain":["HBox(children=(FloatProgress(value=0.0, description='Shuffling glue-test.tfrecord...', max=1063.0, style=Progr…"]},"metadata":{},"output_type":"display_data"},{"name":"stdout","output_type":"stream","text":["\r\u001b[1mDataset glue downloaded and prepared to /root/tensorflow_datasets/glue/cola/1.0.0. Subsequent calls will reuse this data.\u001b[0m\n","Here are some sample rows from glue/cola dataset\n","['unacceptable', 'acceptable']\n","\n","sample row 1\n","b'It is this hat that it is certain that he was wearing.'\n","label: 1 (acceptable)\n","\n","sample row 2\n","b'Her efficient looking up of the answer pleased the boss.'\n","label: 1 (acceptable)\n","\n","sample row 3\n","b'Both the workers will wear carnations.'\n","label: 1 (acceptable)\n","\n","sample row 4\n","b'John enjoyed drawing trees for his syntax homework.'\n","label: 1 (acceptable)\n","\n","sample row 5\n","b'We consider Leslie rather foolish, and Lou a complete idiot.'\n","label: 1 (acceptable)\n","\n"]}],"source":["tfds_name = 'glue/cola' \r\n","\r\n","tfds_info = tfds.builder(tfds_name).info\r\n","\r\n","sentence_features = list(tfds_info.features.keys())\r\n","sentence_features.remove('idx')\r\n","sentence_features.remove('label')\r\n","\r\n","available_splits = list(tfds_info.splits.keys())\r\n","train_split = 'train'\r\n","validation_split = 'validation'\r\n","test_split = 'test'\r\n","if tfds_name == 'glue/mnli':\r\n","  validation_split = 'validation_matched'\r\n","  test_split = 'test_matched'\r\n","\r\n","num_classes = tfds_info.features['label'].num_classes\r\n","num_examples = tfds_info.splits.total_num_examples\r\n","\r\n","print(f'Using {tfds_name} from TFDS')\r\n","print(f'This dataset has {num_examples} examples')\r\n","print(f'Number of classes: {num_classes}')\r\n","print(f'Features {sentence_features}')\r\n","print(f'Splits {available_splits}')\r\n","\r\n","with tf.device('/job:localhost'):\r\n","  # batch_size=-1 is a way to load the dataset into memory\r\n","  in_memory_ds = tfds.load(tfds_name, batch_size=-1, shuffle_files=True)\r\n","\r\n","# The code below is just to show some samples from the selected dataset\r\n","print(f'Here are some sample rows from {tfds_name} dataset')\r\n","sample_dataset = tf.data.Dataset.from_tensor_slices(in_memory_ds[train_split])\r\n","\r\n","labels_names = tfds_info.features['label'].names\r\n","print(labels_names)\r\n","print()\r\n","\r\n","sample_i = 1\r\n","for sample_row in sample_dataset.take(5):\r\n","  samples = [sample_row[feature] for feature in sentence_features]\r\n","  print(f'sample row {sample_i}')\r\n","  for sample in samples:\r\n","    print(sample.numpy())\r\n","  sample_label = sample_row['label']\r\n","\r\n","  print(f'label: {sample_label} ({labels_names[sample_label]})')\r\n","  print()\r\n","  sample_i += 1"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"1-X2EbBfk_d8"},"outputs":[],"source":["def get_conf(glue_task):\r\n","    loss = tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True)\r\n","\r\n","    if glue_task is 'glue/cola':\r\n","        metrics = tfa.metrics.MatthewsCorrelationCoefficient()\r\n","    else:\r\n","        metrics = tf.keras.metrics.SparseCategoricalCrossentropy('accuracy', dtype=tf.float32)\r\n","    \r\n","    return metrics, loss"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"NH2tVsO1mBeh"},"outputs":[{"name":"stdout","output_type":"stream","text":["Fine tune model\n","WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f434c4ee5f0\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stderr","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f434c4ee5f0\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stdout","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f434c4eed40\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stderr","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f434c4eed40\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n","/usr/local/lib/python3.7/dist-packages/tensorflow/python/keras/engine/functional.py:595: UserWarning: Input dict contained keys ['idx', 'label'] which did not match any model input. They will be ignored by the model.\n","  [n for n in tensors.keys() if n not in ref_input_names])\n"]},{"name":"stdout","output_type":"stream","text":["Epoch 1/5\n"]},{"name":"stderr","output_type":"stream","text":["/usr/local/lib/python3.7/dist-packages/tensorflow/python/framework/indexed_slices.py:437: UserWarning: Converting sparse IndexedSlices(IndexedSlices(indices=Tensor(\"AdamWeightDecay/gradients/StatefulPartitionedCall:1\", shape=(None,), dtype=int32), values=Tensor(\"clip_by_global_norm/clip_by_global_norm/_0:0\", dtype=float32), dense_shape=Tensor(\"AdamWeightDecay/gradients/StatefulPartitionedCall:2\", shape=(None,), dtype=int32))) to a dense Tensor of unknown shape. This may consume a large amount of memory.\n","  \"shape. This may consume a large amount of memory.\" % value)\n"]},{"name":"stdout","output_type":"stream","text":["267/267 [==============================] - 95s 119ms/step - loss: 0.5787 - accuracy: 2.0489 - val_loss: 0.4717 - val_accuracy: 2.5897\n","Epoch 2/5\n","267/267 [==============================] - 26s 98ms/step - loss: 0.4100 - accuracy: 2.0844 - val_loss: 0.5298 - val_accuracy: 2.7222\n","Epoch 3/5\n","267/267 [==============================] - 26s 99ms/step - loss: 0.2684 - accuracy: 1.2978 - val_loss: 0.5427 - val_accuracy: 2.5348\n","Epoch 4/5\n","267/267 [==============================] - 26s 99ms/step - loss: 0.1942 - accuracy: 0.8980 - val_loss: 0.7042 - val_accuracy: 2.6659\n","Epoch 5/5\n","267/267 [==============================] - 26s 99ms/step - loss: 0.1364 - accuracy: 0.5815 - val_loss: 0.7838 - val_accuracy: 2.7481\n"]}],"source":["epochs = 5\r\n","batch_size = 32\r\n","init_lr = 2e-5\r\n","\r\n","print(f'Fine tune model')\r\n","bert_preprocess_model = build_bert_preprocess_model(sentence_features=sentence_features)\r\n","\r\n","with strategy.scope():\r\n","\r\n","    # Need to be create inside scope\r\n","    metrics, loss = get_conf(tfds_name)\r\n","\r\n","    train_dataset, train_data_size = load_datasets_from_tf_datasets(in_memory_ds, tfds_info, train_split,\r\n","                                                                    batch_size=batch_size, bert_preprocess_model=bert_preprocess_model)\r\n","    steps_per_epoch = train_data_size // batch_size\r\n","    num_train_steps = steps_per_epoch * epochs\r\n","    num_warmup_steps = num_train_steps // 10\r\n","\r\n","    validation_dataset, validation_data_size = load_datasets_from_tf_datasets(\r\n","        in_memory_ds, tfds_info, validation_split, batch_size, bert_preprocess_model\r\n","    )\r\n","\r\n","    validation_steps = validation_data_size // batch_size\r\n","\r\n","    classifier_model = build_classifier_model(num_classes)\r\n","\r\n","    optimizer = optimization.create_optimizer(init_lr, num_train_steps, num_warmup_steps, optimizer_type='adamw')\r\n","\r\n","    classifier_model.compile(optimizer=optimizer, loss=loss, metrics=[metrics])\r\n","\r\n","    classifier_model.fit(\r\n","        x=train_dataset,\r\n","        validation_data=validation_dataset,\r\n","        steps_per_epoch=steps_per_epoch,\r\n","        epochs=epochs,\r\n","        validation_steps=validation_steps\r\n","    )\r\n","\r\n"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"8p-Z5WJauJS6"},"outputs":[{"name":"stdout","output_type":"stream","text":["Saving ./my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12\n"]},{"name":"stderr","output_type":"stream","text":["WARNING:absl:Found untraced functions such as restored_function_body, restored_function_body, restored_function_body, restored_function_body, restored_function_body while saving (showing 5 of 910). These functions will not be directly callable after loading.\n","WARNING:absl:Found untraced functions such as restored_function_body, restored_function_body, restored_function_body, restored_function_body, restored_function_body while saving (showing 5 of 910). These functions will not be directly callable after loading.\n"]},{"name":"stdout","output_type":"stream","text":["INFO:tensorflow:Assets written to: ./my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/assets\n"]},{"name":"stderr","output_type":"stream","text":["INFO:tensorflow:Assets written to: ./my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/assets\n"]}],"source":["main_save_path = \"./my_bert_model\"\r\n","bert_type = tfhub_handle_encoder.split('/')[-2]\r\n","saved_model_name = f'{tfds_name.replace(\"/\", \"-\")}_{bert_type}'\r\n","\r\n","saved_model_path = os.path.join(main_save_path, saved_model_name)\r\n","\r\n","preprocess_inputs = bert_preprocess_model.inputs\r\n","bert_encoder_inputs = bert_preprocess_model(preprocess_inputs)\r\n","bert_outputs = classifier_model(bert_encoder_inputs)\r\n","model_export = tf.keras.Model(preprocess_inputs, bert_outputs)\r\n","\r\n","print(f'Saving {saved_model_path}')\r\n","\r\n","save_options = tf.saved_model.SaveOptions(experimental_io_device=\"/job:localhost\")\r\n","model_export.save(saved_model_path, include_optimizer=False, options=save_options)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"qFh56PO5vuCk"},"outputs":[{"name":"stdout","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f42f8c3edd0\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stderr","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f42f8c3edd0\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stdout","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f42f8c3e8c0\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stderr","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f42f8c3e8c0\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]}],"source":["# Test model\r\n","with tf.device('/job:localhost'):\r\n","    reloaded_model = tf.saved_model.load(saved_model_path)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"A2IymmpbwSLP"},"outputs":[],"source":["def prepare(record):\r\n","  model_inputs = [[record[ft]] for ft in sentence_features]\r\n","  return model_inputs\r\n","\r\n","\r\n","def prepare_serving(record):\r\n","  model_inputs = {ft: record[ft] for ft in sentence_features}\r\n","  return model_inputs\r\n","\r\n","\r\n","def print_bert_results(test, bert_result, dataset_name):\r\n","\r\n","  bert_result_class = tf.argmax(bert_result, axis=1)[0]\r\n","\r\n","  if dataset_name == 'glue/cola':\r\n","    print(f'sentence: {test[0].numpy()}')\r\n","    if bert_result_class == 1:\r\n","      print(f'This sentence is acceptable')\r\n","    else:\r\n","      print(f'This sentence is unacceptable')\r\n","\r\n","  elif dataset_name == 'glue/sst2':\r\n","    print(f'sentence: {test[0]}')\r\n","    if bert_result_class == 1:\r\n","      print(f'This sentence has POSITIVE sentiment')\r\n","    else:\r\n","      print(f'This sentence has NEGATIVE sentiment')\r\n","\r\n","  elif dataset_name == 'glue/mrpc':\r\n","    print(f'sentence1: {test[0]}')\r\n","    print(f'sentence2: {test[1]}')\r\n","    if bert_result_class == 1:\r\n","      print(f'Are a paraphrase')\r\n","    else:\r\n","      print(f'Are NOT a paraphrase')\r\n","\r\n","  elif dataset_name == 'glue/qqp':\r\n","    print(f'question1: {test[0]}')\r\n","    print(f'question2: {test[1]}')\r\n","    if bert_result_class == 1:\r\n","      print(f'Questions are similar')\r\n","    else:\r\n","      print(f'Questions are NOT similar')\r\n","\r\n","  elif dataset_name == 'glue/mnli':\r\n","    print(f'premise   : {test[0]}')\r\n","    print(f'hypothesis: {test[1]}')\r\n","    if bert_result_class == 1:\r\n","      print(f'This premise is NEUTRAL to the hypothesis')\r\n","    elif bert_result_class == 2:\r\n","      print(f'This premise CONTRADICTS the hypothesis')\r\n","    else:\r\n","      print(f'This premise ENTAILS the hypothesis')\r\n","\r\n","  elif dataset_name == 'glue/qnli':\r\n","    print(f'question: {test[0]}')\r\n","    print(f'sentence: {test[1]}')\r\n","    if bert_result_class == 1:\r\n","      print(f'The question is NOT answerable by the sentence')\r\n","    else:\r\n","      print(f'The question is answerable by the sentence')\r\n","\r\n","  elif dataset_name == 'glue/rte':\r\n","    print(f'sentence1: {test[0]}')\r\n","    print(f'sentence2: {test[1]}')\r\n","    if bert_result_class == 1:\r\n","      print(f'Sentence1 DOES NOT entails sentence2')\r\n","    else:\r\n","      print(f'Sentence1 entails sentence2')\r\n","\r\n","  elif dataset_name == 'glue/wnli':\r\n","    print(f'sentence1: {test[0]}')\r\n","    print(f'sentence2: {test[1]}')\r\n","    if bert_result_class == 1:\r\n","      print(f'Sentence1 DOES NOT entails sentence2')\r\n","    else:\r\n","      print(f'Sentence1 entails sentence2')\r\n","\r\n","  print(f'Bert raw results:{bert_result[0]}')\r\n","  print()"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"jCf7920cwTQx"},"outputs":[{"name":"stdout","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f42f8c2c170\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stderr","output_type":"stream","text":["WARNING:tensorflow:10 out of the last 11 calls to \u003cfunction recreate_function.\u003clocals\u003e.restored_function_body at 0x7f42f8c2c170\u003e triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.\n"]},{"name":"stdout","output_type":"stream","text":["sentence: [b'I saw the astronomer with a telescope.']\n","This sentence is acceptable\n","Bert raw results:[-4.440919   2.7251322]\n","\n","sentence: [b'Somebody just left - guess who just left.']\n","This sentence is acceptable\n","Bert raw results:[-3.8689706  2.3567994]\n","\n","sentence: [b'Yes, too much so.']\n","This sentence is acceptable\n","Bert raw results:[-1.2051959   0.42129737]\n","\n","sentence: [b'I wonder who saw Bill and liked Mary.']\n","This sentence is acceptable\n","Bert raw results:[-3.1723185  1.8008618]\n","\n","sentence: [b'Which man drove the car?']\n","This sentence is acceptable\n","Bert raw results:[-3.6100965  2.2806292]\n","\n"]}],"source":["with tf.device('/job:localhost'):\r\n","    test_dataset = tf.data.Dataset.from_tensor_slices(in_memory_ds[test_split])\r\n","\r\n","    for row in test_dataset.shuffle(1000).map(prepare).take(5):\r\n","        if len(sentence_features) == 1:\r\n","            result = reloaded_model(row[0])\r\n","        else:\r\n","            result = reloaded_model(list(row))\r\n","        \r\n","        print_bert_results(row, result, tfds_name)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"xS5oMO9MxunV"},"outputs":[{"name":"stdout","output_type":"stream","text":["sentence: b\"The newspaper has reported that they are about to appoint someone, but I can't remember who.\"\n","This sentence is acceptable\n","Bert raw results:[-3.460811   2.2095237]\n","\n","sentence: b\"The administration has issued a statement that it is willing to meet with one of the student groups, but I'm not sure which one.\"\n","This sentence is acceptable\n","Bert raw results:[-2.5723596  1.5756365]\n","\n","sentence: b'Good cooks are made by them.'\n","This sentence is unacceptable\n","Bert raw results:[ 1.3139793 -1.2374688]\n","\n","sentence: b'John thinks for Bill to leave.'\n","This sentence is unacceptable\n","Bert raw results:[ 1.9551344 -1.5678914]\n","\n","sentence: b\"This pen doesn't write.\"\n","This sentence is acceptable\n","Bert raw results:[-3.2623603  2.148901 ]\n","\n"]}],"source":["with tf.device('/job:localhost'):\r\n","    serving_model = reloaded_model.signatures['serving_default']\r\n","    for test_row in test_dataset.shuffle(1000).map(prepare_serving).take(5):\r\n","        result = serving_model(**test_row)\r\n","        # The 'prediction' key is the classifier's defined model name.\r\n","        print_bert_results(list(test_row.values()), result['prediction'], tfds_name)"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"background_save":true},"id":"BBJKXIQUwVl2"},"outputs":[{"name":"stdout","output_type":"stream","text":["  adding: content/my_bert_model/ (stored 0%)\n","  adding: content/my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/ (stored 0%)\n","  adding: content/my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/assets/ (stored 0%)\n","  adding: content/my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/assets/vocab.txt (deflated 53%)\n","  adding: content/my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/saved_model.pb (deflated 93%)\n","  adding: content/my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/variables/ (stored 0%)\n","  adding: content/my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/variables/variables.index (deflated 82%)\n","  adding: content/my_bert_model/glue-cola_bert_en_uncased_L-12_H-768_A-12/variables/variables.data-00000-of-00001 (deflated 19%)\n"]},{"data":{"application/javascript":["\n","    async function download(id, filename, size) {\n","      if (!google.colab.kernel.accessAllowed) {\n","        return;\n","      }\n","      const div = document.createElement('div');\n","      const label = document.createElement('label');\n","      label.textContent = `Downloading \"${filename}\": `;\n","      div.appendChild(label);\n","      const progress = document.createElement('progress');\n","      progress.max = size;\n","      div.appendChild(progress);\n","      document.body.appendChild(div);\n","\n","      const buffers = [];\n","      let downloaded = 0;\n","\n","      const channel = await google.colab.kernel.comms.open(id);\n","      // Send a message to notify the kernel that we're ready.\n","      channel.send({})\n","\n","      for await (const message of channel.messages) {\n","        // Send a message to notify the kernel that we're ready.\n","        channel.send({})\n","        if (message.buffers) {\n","          for (const buffer of message.buffers) {\n","            buffers.push(buffer);\n","            downloaded += buffer.byteLength;\n","            progress.value = downloaded;\n","          }\n","        }\n","      }\n","      const blob = new Blob(buffers, {type: 'application/binary'});\n","      const a = document.createElement('a');\n","      a.href = window.URL.createObjectURL(blob);\n","      a.download = filename;\n","      div.appendChild(a);\n","      a.click();\n","      div.remove();\n","    }\n","  "],"text/plain":["\u003cIPython.core.display.Javascript object\u003e"]},"metadata":{},"output_type":"display_data"},{"data":{"application/javascript":["download(\"download_fdcb885e-0dd2-48d2-9bd5-d135aa77fc5a\", \"download.zip\", 1068846269)"],"text/plain":["\u003cIPython.core.display.Javascript object\u003e"]},"metadata":{},"output_type":"display_data"}],"source":["!zip -r /content/download.zip /content/my_bert_model\r\n","\r\n","from google.colab import files\r\n","files.download('/content/download.zip')"]}],"metadata":{"accelerator":"TPU","colab":{"authorship_tag":"ABX9TyNqxbiI48QxBtG3vmyHIpY8","name":"BERT","version":""},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}